# Microsoft BASIC M6502 完全命令セット解析

## 1. BASICコマンド（STMDSP テーブル）

### 基本制御
- `END` - プログラム終了
- `STOP` - プログラム一時停止
- `RUN` - プログラム実行
- `CONT` - 実行継続
- `NEW` (SCRATH) - プログラムクリア

### 制御構造
- `FOR` - ループ開始
- `NEXT` - ループ終了
- `IF` - 条件分岐
- `GOTO` - 無条件ジャンプ
- `GOSUB` - サブルーチン呼び出し
- `RETURN` - サブルーチンから復帰
- `ON` (ONGOTO) - 多分岐

### データ操作
- `LET` - 変数代入
- `DIM` - 配列次元定義
- `DATA` - データ定義
- `READ` - データ読み取り
- `RESTORE` - データポインターリセット
- `INPUT` - ユーザー入力
- `INPUT#` - チャンネル入力（条件付き）

### 入出力
- `PRINT` - 標準出力
- `PRINT#` - チャンネル出力（条件付き）
- `LIST` - プログラム一覧表示

### ファイル操作（条件付き）
- `LOAD` - プログラム読み込み
- `SAVE` - プログラム保存
- `VERIFY` - プログラム検証

### システム
- `CLEAR` - メモリクリア
- `POKE` - メモリ書き込み
- `DEF` - ユーザー定義関数
- `REM` - コメント
- `NULL` - NULL文（条件付き）
- `WAIT` (FNWAIT) - 待機
- `GET` - 文字入力（条件付き）

### 拡張コマンド（条件付き）
- `CMD` - コマンド実行
- `SYS` (CQSYS) - システム呼び出し
- `OPEN` (CQOPEN) - ファイルオープン
- `CLOSE` (CQCLOS) - ファイルクローズ

## 2. BASIC関数（FUNDSP テーブル）

### 数学関数
- `SGN(x)` - 符号関数
- `INT(x)` - 整数部取得
- `ABS(x)` - 絶対値
- `SQR(x)` - 平方根
- `EXP(x)` - 指数関数
- `LOG(x)` - 自然対数
- `RND(x)` - 乱数生成

### 三角関数（条件付き）
- `SIN(x)` - サイン
- `COS(x)` - コサイン
- `TAN(x)` - タンジェント
- `ATN(x)` - アークタンジェント

### システム関数
- `USR(x)` - ユーザー関数
- `FRE(x)` - 空きメモリ
- `POS(x)` - カーソル位置
- `PEEK(x)` - メモリ読み取り

### 文字列関数
- `LEN(s$)` - 文字列長
- `ASC(s$)` - 文字コード取得
- `CHR$(x)` - 文字コード変換
- `STR$(x)` - 数値→文字列変換
- `VAL(s$)` - 文字列→数値変換
- `LEFT$(s$,n)` - 左部分文字列
- `RIGHT$(s$,n)` - 右部分文字列
- `MID$(s$,n,m)` - 中間部分文字列

## 3. 演算子（OPTAB テーブル）

### 算術演算子
- `+` - 加算（優先度121）
- `-` - 減算（優先度121）
- `*` - 乗算（優先度123）
- `/` - 除算（優先度123）
- `^` - べき乗（優先度127）

### 論理演算子
- `AND` - 論理積（優先度80）
- `OR` - 論理和（優先度70）
- `NOT` - 論理否定（優先度90）

### 単項演算子
- `-` - 符号反転（優先度125）

### 関係演算子
- `=` - 等しい
- `<` - より小さい
- `>` - より大きい
- `<=` - 以下
- `>=` - 以上
- `<>` - 等しくない

## 4. 実装優先度

### Phase 2: 制御構造（高優先度）
1. `FOR...NEXT` ループ
2. `IF...THEN` 条件分岐
3. `GOSUB...RETURN` サブルーチン
4. `ON...GOTO` 多分岐

### Phase 3: 数学関数（中優先度）
1. 基本数学関数（SGN, INT, ABS, SQR）
2. 指数・対数関数（EXP, LOG）
3. 三角関数（SIN, COS, TAN, ATN）
4. 乱数関数（RND）

### Phase 4: 文字列関数（中優先度）
1. 基本文字列関数（LEN, ASC, CHR$）
2. 変換関数（STR$, VAL）
3. 部分文字列関数（LEFT$, RIGHT$, MID$）

### Phase 5: 配列とデータ（中優先度）
1. `DIM` - 配列定義
2. `DATA...READ...RESTORE` - データ処理
3. 多次元配列サポート

### Phase 6: 式評価エンジン（高優先度）
1. 演算子優先度処理
2. 関数呼び出し
3. 変数参照
4. 型変換

### Phase 7: システム機能（低優先度）
1. `PEEK/POKE` - メモリアクセス
2. `FRE/POS` - システム情報
3. ファイル操作（LOAD/SAVE）

## 5. 設計拡張ポイント

### データ構造拡張
- FOR-NEXTスタック管理
- GOSUB-RETURNスタック管理
- 配列記述子テーブル
- データ文ポインター管理

### パーサー拡張
- 複合文の解析
- 式の再帰的評価
- 型チェック強化
- エラー回復機能

### 実行エンジン拡張
- プログラムカウンター管理
- スタックフレーム管理
- ガベージコレクション
- デバッグ機能

